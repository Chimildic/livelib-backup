<script>
    const STATUS = {
        starting: [
            'Ожидаю ответ сервера',
            'Вперед, в бездну!',
            'Первый шаг, а там посмотрим...',
            'Поехали!',
            'Хьюстон, у нас контакт',
            'Глубоко вдохнули и... парсим!',
            'Глаза боятся, а парсер делает',
            'Маховик запущен, назад пути нет',
            'Использую магию вне Хогвартса, никому не рассказывай',
            'Даже карта Мародеров не собирет столько информации',
            'Надеюсь, этот парсинг не приведет нас в Тайную Комнату',
            'Ну-с, – бодро сказал он, – начнем пожалуй',
            'Да будет бал, да начнутся танцы!',
            'Это будет леген... постой, подожди-подожди... дарно! Процесс пошел',
            'Даже тысячемильное путешествие начинается с... запуска скрипта. Ладно, метафора так себе, но суть ясна',
            'Заяц, Волк, Заяц, Волк',
            'Работает? Не знаю, но кнопка нажата',
            'А пока покормите котейку. Ну, или себя?',
            'Вы знали что Алиса умеет озвучивать книги? На телефоне тоже',
        ],
        isNotLastPage: [
            'Продолжаю собирать книжки',
            'Кажется, кто-то ограбил библиотеку?',
            'Вы точно всё это читали, или просто хвастаетесь?',
            'Вы, наверное, тот самый книжный червь, о котором все говорят?',
            'Вам срочно нужен книжный шкаф побольше, а лучше два!',
            'Я не завис (наверное)',
            'while (true) read()',
        ],
        creatingFile: [
            'Записываю данные в файл',
            'Строка за строкой, файл скоро будет твой',
            'Создать файл? Легче лёгкого, когда у тебя есть куча свободного времени и марсианская пыль на процессоре.',
        ]
    }

    const progressModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('progressModal'))

    let isExportCanceled = false
    document.getElementById('cancelExport').addEventListener('click', () => (isExportCanceled = true))
    document.querySelector('form').addEventListener('submit', onFormSubmit)

    function onFormSubmit(event) {
        event.preventDefault()
        isExportCanceled = false
        let formDataObject = fromFormDataToObject(new FormData(event.target))
        if (formDataObject.username.length == 0) {
            return
        }

        setRandomProgressStatus(STATUS.starting)
        progressModal.show()

        getBiglist({
            args: { pagename: formDataObject.pagename, username: formDataObject.username, includeColumns: formDataObject.includeColumns },
            formData: formDataObject,
        })
    }

    function getBiglist(userObject) {
        try {
            google.script.run
                .withUserObject(userObject)
                .withSuccessHandler(onSuccess)
                .withFailureHandler(onFailure)
            ['getBiglist'](userObject.args)
        } catch (error) {
            throw error.message;
        }
    }

    function onSuccess(response, userObject) {
        throwIfCancelByUser()
        userObject.bookArray = userObject.bookArray || []
        userObject.bookArray.push(...response.bookArray)
        if (response.isLastPage) {
            delete userObject.args
            userObject.totalPages = response.pageNumber
            onFinish(userObject)
        } else {
            setRandomProgressStatus(STATUS.isNotLastPage)
            userObject.args.pageNumber = response.pageNumber + 1
            getBiglist(userObject)
        }
    }

    function onFailure(error, userObject) {
        console.log('Ошибка в getBiglist.\nСообщение:', error.message, '\nuserObject:', userObject)
    }

    function onFinish(userObject) {
        setRandomProgressStatus(STATUS.creatingFile)
        let filename = createFilename(userObject.formData)
        if (userObject.formData.fileExtention == 'json') {
            download(filename, 'application/json', JSON.stringify(userObject.bookArray))
        } else if (userObject.formData.fileExtention == 'csv') {
            download(filename, 'text/csv', fromBookArrayToCsv(userObject))
        }
        progressModal.hide()

    }

    function download(filename, mimeType, content) {
        let blob = new Blob([content], { type: [mimeType, 'charset=utf-8'].join(';') })
        let url = URL.createObjectURL(blob)

        let aElement = document.createElement('a')
        aElement.href = url
        aElement.download = filename

        throwIfCancelByUser()
        aElement.click()

        aElement.remove()
        URL.revokeObjectURL(url)
    }

    function createFilename(formData) {
        return `livelib-${formData.username.toLowerCase()}-${formData.pagename}-${new Date().toLocaleDateString()}.${formData.fileExtention}`
    }

    function fromFormDataToObject(formData) {
        return formData.entries().reduce((acc, [key, value]) => {
            if (acc[key] == undefined) {
                acc[key] = value
            } else if (Array.isArray(acc[key])) {
                acc[key].push(value)
            } else {
                acc[key] = [acc[key]]
                acc[key].push(value)
            }
            return acc
        }, {})
    }

    function fromBookArrayToCsv(userObject, separator = ';') {
        let columnTitles = FIELDS_DATA.items.reduce((acc, item) => (acc[item.value] = item.text, acc), {})
        let header = userObject.formData.includeColumns.map(item => columnTitles[item]).join(separator)
        let lines = []
        for (let i = 0; i < userObject.bookArray.length; i++) {
            throwIfCancelByUser()
            let book = userObject.bookArray[i]
            let line = []
            userObject.formData.includeColumns.forEach(column => {
                if (column == 'authors') {
                    line.push(book.authors.map(a => a.name).join(','))
                } else if (column == 'ratingUser') {
                    line.push(book.rating.user)
                } else if (column == 'ratingOverall') {
                    line.push(book.rating.overall)
                } else if (['isbn', 'year', 'language', 'series', 'publishers'].includes(column)) {
                    line.push(book.details[column])
                } else if (column == 'genres') {
                    line.push(book.genres.map(item => item.name).join(','))
                } else if (['loved', 'reviews', 'quotes', 'read'].includes(column)) {
                    line.push(book.stats[column])
                } else {
                    line.push(book[column])
                }
            })
            lines.push(line.join(separator))
        }

        return [header, lines].flat().join('\n')
    }

    function setRandomProgressStatus(array) {
        let index = Math.floor(Math.random() * array.length)
        document.getElementById('progressStatus').innerText = array[index]
    }

    function throwIfCancelByUser() {
        if (isExportCanceled) {
            throw 'Прервано пользователем'
        }
    }
</script>